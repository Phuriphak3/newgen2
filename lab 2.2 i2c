#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <Adafruit_I2CDevice.h> // ต้องใช้ตัวนี้ตามโจทย์

#define DS1307_ADDRESS 0x68
#define LCD_ADDRESS    0x27

// สร้าง Object I2C Device สำหรับ DS1307
Adafruit_I2CDevice rtc_dev = Adafruit_I2CDevice(DS1307_ADDRESS);
LiquidCrystal_I2C lcd(LCD_ADDRESS, 16, 2);

// ฟังก์ชันแปลง BCD ตามโจทย์กำหนด
static uint8_t bcdToDec(uint8_t bcd) {
  return (uint8_t)(10 * (bcd >> 4) + (bcd & 0x0F));
}

void setup() {
  Serial.begin(115200);
  
  // ตรวจหาอุปกรณ์ I2C (Device Detect)
  if (!rtc_dev.begin()) {
    Serial.println("Could not find DS1307!");
    while (1);
  }
  Serial.println("DS1307 Found!");

  lcd.init();
  lcd.backlight();
}

void loop() {
  uint8_t read_buf[7];      // Buffer สำหรับเก็บข้อมูล 7 byte (0x00 - 0x06)
  uint8_t reg_addr[1] = {0x00}; // เริ่มอ่านจาก Register 0x00

  // --- ขั้นตอนสำคัญของ Lab 2.2: ใช้ write_then_read ---
  // เขียน 0x00 ลงไปก่อนเพื่อบอกว่าจะอ่านที่ไหน แล้วอ่านกลับมา 7 byte
  rtc_dev.write_then_read(reg_addr, 1, read_buf, 7);

  // แปลงค่าจาก Buffer (BCD -> Decimal)
  uint8_t second     = bcdToDec(read_buf[0] & 0x7F);
  uint8_t minute     = bcdToDec(read_buf[1]);
  uint8_t hour       = bcdToDec(read_buf[2] & 0x3F); // โหมด 24 ชม.
  uint8_t dayOfMonth = bcdToDec(read_buf[4]);
  uint8_t month      = bcdToDec(read_buf[5]);
  uint8_t year       = bcdToDec(read_buf[6]);

  // แสดงผลบน LCD
  lcd.setCursor(0, 0);
  lcd.printf("Date: %02d/%02d/20%02d", dayOfMonth, month, year);

  lcd.setCursor(0, 1);
  lcd.printf("Time: %02d:%02d:%02d", hour, minute, second);

  delay(1000);
}
