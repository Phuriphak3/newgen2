#include <WiFi.h>
#include <MQTT.h>

const char ssid[] = "ASUS8275";
const char pass[] = "8516W/3i";

const char mqtt_broker[] = "test.mosquitto.org"; 
const char mqtt_client_id[] = "esp32_hbridge_logic_001"; // แนะนำให้เติมชื่อเพิ่มเพื่อไม่ให้ซ้ำกับคนอื่น
int MQTT_PORT = 1883;

// --- MQTT Topics ---
const char topic_status_motor[] = "myhome/motor/status"; 
const char topic_status_led[]   = "myhome/led/status";   
const char topic_cmd_motor[]    = "myhome/set_motor";    
const char topic_cmd_led[]      = "myhome/set_led";      

// --- Pin Definitions ---
const int PIN_MOTOR_IN1 = 16; 
const int PIN_MOTOR_IN2 = 17; 
const int PIN_LED = 2;        
const int PIN_BUTTON = 32;   

// --- Global Variables ---
WiFiClient net;
MQTTClient client;

unsigned long lastMillis = 0;
int motorStep = 0;      // 0:หยุด, 1:ซ้าย, 2:ขวา
int lastDirection = 1;  // จำทิศทางล่าสุด
bool ledState = false;

int lastButtonState = HIGH;
unsigned long lastDebounceTime = 0;
unsigned long debounceDelay = 50;

void publishStatus() {
  String motorMsg = (motorStep == 1) ? "Left" : (motorStep == 2) ? "Right" : "Stop";
  String ledMsg = (ledState) ? "ON" : "OFF";
  client.publish(topic_status_motor, motorMsg);
  client.publish(topic_status_led, ledMsg);
  Serial.println("Status Published -> Motor: " + motorMsg + ", LED: " + ledMsg);
}

void updateHardware(int step) {
  motorStep = step;
  
  // ป้องกันการลัดวงจรหรือกระชาก (หยุดก่อนเปลี่ยนทิศทาง)
  digitalWrite(PIN_MOTOR_IN1, LOW);
  digitalWrite(PIN_MOTOR_IN2, LOW);
  delay(50); 

  if (motorStep == 1) { // หมุนซ้าย
    digitalWrite(PIN_MOTOR_IN1, HIGH);
    digitalWrite(PIN_MOTOR_IN2, LOW);
    digitalWrite(PIN_LED, HIGH);
    ledState = true;
    lastDirection = 1;
  } 
  else if (motorStep == 2) { // หมุนขวา
    digitalWrite(PIN_MOTOR_IN1, LOW);
    digitalWrite(PIN_MOTOR_IN2, HIGH);
    digitalWrite(PIN_LED, HIGH);
    ledState = true;
    lastDirection = 2;
  } 
  else { // หยุด
    digitalWrite(PIN_LED, LOW);
    ledState = false;
    motorStep = 0;
  }
  publishStatus();
}

void connect() {
  Serial.print("\nWiFi/MQTT Connecting...");
  while (WiFi.status() != WL_CONNECTED) { delay(500); Serial.print("."); }
  while (!client.connect(mqtt_client_id)) { delay(500); Serial.print("x"); }
  
  Serial.println("\nConnected to Broker!");
  client.subscribe(topic_cmd_motor);
  client.subscribe(topic_cmd_led);
}

void messageReceived(String &topic, String &payload) {
  Serial.println("MQTT Incoming -> " + topic + ": " + payload);
  
  if (topic == topic_cmd_motor) {
    if (payload == "left") updateHardware(1);
    else if (payload == "right") updateHardware(2);
    else if (payload == "stop") updateHardware(0);
  }
  
  if (topic == topic_cmd_led) {
    if (payload == "toggle") {
      if (!ledState) {
        int newDir = (lastDirection == 1) ? 2 : 1;
        updateHardware(newDir);
      } else {
        updateHardware(0);
      }
    }
  }
}

void setup() {
  Serial.begin(115200); // ปรับเป็น 115200
  pinMode(PIN_MOTOR_IN1, OUTPUT);
  pinMode(PIN_MOTOR_IN2, OUTPUT);
  pinMode(PIN_LED, OUTPUT);
  pinMode(PIN_BUTTON, INPUT_PULLUP);

  WiFi.begin(ssid, pass);
  client.begin(mqtt_broker, MQTT_PORT, net);
  client.onMessage(messageReceived);
  
  connect();
  updateHardware(0); // เริ่มต้นด้วยการหยุด
}

void loop() {
  client.loop();
  if (!client.connected()) connect();

  // Logic ปุ่มกด
  int reading = digitalRead(PIN_BUTTON);
  if (reading != lastButtonState) {
    lastDebounceTime = millis();
  }

  if ((millis() - lastDebounceTime) > debounceDelay) {
    static int buttonState = HIGH;
    if (reading != buttonState) {
      buttonState = reading;
      if (buttonState == LOW) { 
        int nextStep = motorStep + 1;
        if (nextStep > 2) nextStep = 0;
        updateHardware(nextStep);
      }
    }
  }
  lastButtonState = reading;

  // ส่งสถานะอัปเดตทุก 5 วินาที (เพื่อให้ Broker ไม่ทำงานหนักเกินไป)
  if (millis() - lastMillis > 5000) {
    lastMillis = millis();
    if (client.connected()) publishStatus();
  }
}
